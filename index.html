<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>國語生詞學期總複習中心</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; touch-action: manipulation; }
        .screen { display: none; }
        .menu-btn { transition: all 0.2s ease-in-out; }
        .menu-btn:hover { transform: translateY(-4px) scale(1.02); box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
        
        /* Flashcard Styles */
        .flashcard-container { perspective: 1000px; }
        .flashcard-inner { position: relative; width: 100%; height: 100%; transition: transform 0.6s; transform-style: preserve-3d; }
        .flashcard-container.is-flipped .flashcard-inner { transform: rotateY(180deg); }
        .flashcard-front, .flashcard-back { position: absolute; width: 100%; height: 100%; -webkit-backface-visibility: hidden; backface-visibility: hidden; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 1.5rem; border-radius: 1.5rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); overflow-y: auto; }
        .flashcard-front { background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); color: #0c4a6e; }
        .flashcard-back { background: linear-gradient(135deg, #fefce8 0%, #fffbeb 100%); color: #713f12; transform: rotateY(180deg); }
        
        /* Matching Game Styles */
        .match-item { transition: all 0.5s ease-in-out; cursor: pointer; border: 2px solid #cbd5e1; }
        .match-item:hover { background-color: #f1f5f9; border-color: #94a3b8; }
        .match-item.selected { background-color: #bae6fd; border-color: #38bdf8; transform: scale(1.05); }
        .match-item.matched { opacity: 0; transform: scale(0.9); height: 0; padding-top: 0; padding-bottom: 0; margin-top: -2px; margin-bottom: 0; border-width: 0; pointer-events: none; }
        .match-item.incorrect { background-color: #fee2e2; border-color: #f87171; animation: shake 0.5s; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }

        /* Memory Game Styles */
        .memory-card { perspective: 1000px; cursor: pointer; }
        .memory-card-inner { position: relative; width: 100%; height: 100%; transition: transform 0.5s; transform-style: preserve-3d; }
        .memory-card.is-flipped .memory-card-inner { transform: rotateY(180deg); }
        .memory-card-front, .memory-card-back { position: absolute; width: 100%; height: 100%; -webkit-backface-visibility: hidden; backface-visibility: hidden; display: flex; justify-content: center; align-items: center; border-radius: 0.75rem; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .memory-card-front { background: linear-gradient(135deg, #60a5fa, #3b82f6); color: white; font-size: 2rem; }
        .memory-card-back { background-color: #f1f5f9; transform: rotateY(180deg); padding: 8px; font-size: 0.9rem; text-align: center; }
        .memory-card.matched { opacity: 0; transform: scale(0); transition: all 0.5s; }
    </style>
</head>
<body class="bg-slate-100 flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-3xl mx-auto">
        
        <!-- Lesson Selection Screen -->
        <div id="screen-lesson-select" class="screen" style="display: block;">
            <div class="text-center mb-8">
                <h1 class="text-3xl sm:text-4xl font-bold text-sky-800">國語生詞總複習</h1>
                <p class="text-slate-500 mt-2">請選擇要練習的課次</p>
            </div>
            <div id="lesson-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 sm:gap-6">
                <!-- Lesson buttons will be generated by JS -->
            </div>
        </div>

        <!-- Game Mode Selection Screen -->
        <div id="screen-gamemode-select" class="screen">
            <div class="text-center mb-8">
                <h1 id="gamemode-title" class="text-3xl sm:text-4xl font-bold text-sky-800"></h1>
                <p class="text-slate-500 mt-2">請選擇學習模式</p>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 sm:gap-6">
                 <button onclick="startMode('flashcard-word')" class="menu-btn bg-white p-6 rounded-xl shadow-md text-left">
                    <h2 class="text-xl font-bold text-slate-800">📖 閃卡練習</h2>
                    <p class="text-slate-500 mt-1">看詞語，回想解釋和造句。</p>
                </button>
                <button onclick="startMode('flashcard-def')" class="menu-btn bg-white p-6 rounded-xl shadow-md text-left">
                    <h2 class="text-xl font-bold text-slate-800">🤔 反向閃卡</h2>
                    <p class="text-slate-500 mt-1">看解釋，回想正確的詞語。</p>
                </button>
                <button onclick="startMode('matching')" class="menu-btn bg-white p-6 rounded-xl shadow-md text-left">
                    <h2 class="text-xl font-bold text-slate-800">🔗 配對遊戲</h2>
                    <p class="text-slate-500 mt-1">將詞語和對應的解釋連起來！</p>
                </button>
                <button onclick="startMode('memory')" class="menu-btn bg-white p-6 rounded-xl shadow-md text-left">
                    <h2 class="text-xl font-bold text-slate-800">🧠 記憶遊戲</h2>
                    <p class="text-slate-500 mt-1">翻開卡牌，找出所有配對。</p>
                </button>
                <button onclick="startMode('quiz')" class="menu-btn bg-white p-6 rounded-xl shadow-md text-left md:col-span-2">
                    <h2 class="text-xl font-bold text-slate-800">✏️ 綜合測驗</h2>
                    <p class="text-slate-500 mt-1">透過填空題，檢驗你的學習成果。</p>
                </button>
            </div>
             <div class="mt-8 text-center">
                <button onclick="showScreen('lesson-select')" class="bg-white text-slate-600 px-6 py-3 rounded-full shadow-sm hover:bg-slate-100">返回課次選擇</button>
            </div>
        </div>


        <!-- Universal Header for games -->
        <div id="game-header" class="hidden items-center mb-4">
            <button onclick="showScreen('gamemode-select')" class="bg-white text-slate-600 px-4 py-2 rounded-lg shadow-sm hover:bg-slate-100">返回模式選擇</button>
            <h2 id="game-title" class="text-xl font-bold text-sky-800 mx-auto"></h2>
            <div class="w-36"></div> <!-- Placeholder for centering title -->
        </div>

        <!-- Flashcard Screen -->
        <div id="screen-flashcard" class="screen">
            <!-- Flashcard content remains the same -->
        </div>

        <!-- Matching Game Screen -->
        <div id="screen-matching" class="screen">
            <!-- Matching game content remains the same -->
        </div>

        <!-- Memory Game Screen -->
        <div id="screen-memory" class="screen">
            <!-- Memory game content remains the same -->
        </div>

        <!-- Quiz Screen -->
        <div id="screen-quiz" class="screen bg-white p-6 sm:p-8 rounded-2xl shadow-lg">
            <!-- Quiz content will be injected here -->
        </div>
        
    </div>

<script>
// --- ALL LESSONS DATA ---
const allLessonsData = [
    {
        title: "第一課 跑道",
        vocabulary: [
            { word: "年級", definition: "學校中依據學生的修業年限和課程所分的學級。", sentence: "過了暑假，他就是高中三______的學生了。" },
            { word: "壓軸", definition: "比喻最精采、最引人注目的節目或事件。", sentence: "今晚的______表演即將隆重登場，請大家拭目以待。" },
            { word: "爭奪", definition: "爭相奪取，互不退讓。", sentence: "人生在世，不需費盡心思去______名利。" },
            { word: "委屈", definition: "因遭受不合理的待遇而感到難過。", sentence: "我們可以向朋友傾吐心中的______。" },
            { word: "偏心", definition: "偏袒一方，對某一方存私心。", sentence: "老師對每位同學都一視同仁，絲毫沒有______。" },
            { word: "搬運", definition: "把東西搬動、運送到別處。", sentence: "那個骨董花瓶在______過程中不慎摔壞了。" },
            { word: "怨恨", definition: "埋怨忿恨。", sentence: "______別人就是傷害自己，懂得原諒才能得到快樂。" },
            { word: "抑制", definition: "壓抑控制。", sentence: "他______不住內心的悲傷，眼淚奪眶而出。" },
            { word: "拒絕", definition: "不接受、不答應。", sentence: "為了維持健康，應______食用有非法添加物的食品。" },
            { word: "尷尬", definition: "不好意思、難為情。", sentence: "說話不經思考就脫口而出，容易造成______的場面。" },
            { word: "後悔", definition: "事後懊悔當初的不該。", sentence: "應該謹言慎行，不要做出讓自己______的事情。" },
            { word: "拱手讓人", definition: "輕易的把東西讓給別人。", sentence: "今年的冠軍獎座只能______了。" },
            { word: "距離", definition: "時間或空間、有形或無形的間隔。", sentence: "真誠的溝通可以拉近彼此的______。" },
            { word: "默默", definition: "沉靜不說話。", sentence: "社會上有許多善心人士，______的貢獻自己的力量。" },
            { word: "鬥志", definition: "奮發進取的意志。", sentence: "在加油聲中，球員們個個______高昂。" },
            { word: "扭曲", definition: "歪曲、顛倒。", sentence: "為了開脫罪嫌，他不惜顛倒是非、______事實。" },
            { word: "猛然", definition: "突然。", sentence: "到了辦公室，他才______想起家裡瓦斯爐忘了關。" },
            { word: "無理取鬧", definition: "比喻不合情理的吵鬧或故意的搗亂。", sentence: "他因為一點小事就______，讓大家都很困擾。" },
            { word: "勝券在握", definition: "比喻很有把握，相信自己可以成功勝利。", sentence: "看他信心滿滿的樣子，想必是______了。" },
            { word: "勢均力敵", definition: "雙方力量或情勢相當。", sentence: "這場比賽雙方______，勝負難料。" },
            { word: "盡心盡力", definition: "費盡心思、竭盡力量。", sentence: "對於這次的任務，他______的做到最好。" },
            { word: "不相上下", definition: "形容彼此差不多，難以分出高下。", sentence: "他們兩人的棋藝______，很難分出勝負。" },
        ]
    },
    {
        title: "第二課 朱子治家格言選",
        vocabulary: [
            { word: "綢繆", definition: "纏繞束縛，本課指修補器物，讓它更加堅固。", sentence: "颱風即將來襲，我們應未雨______做好防災準備。" },
            { word: "掘井", definition: "挖井。", sentence: "古代先民得先______才能汲水，不像我們有自來水可用。" },
            { word: "纏繞", definition: "圍繞束縛。", sentence: "絲瓜藤______著竹架逐漸向上攀生。" },
            { word: "束縛", definition: "拘束或限制。", sentence: "小鹿掙開繩圈的______，迅速跑向叢林。" },
            { word: "瓦缶", definition: "用來盛裝酒或水的陶器。", sentence: "______不僅可以作為容器，也可以作為敲擊樂器。" },
            { word: "珍饈", definition: "珍奇美味的食物。", sentence: "只要是媽媽煮的，全家人都視為______佳肴。" },
            { word: "施惠", definition: "給予恩惠、德澤。", sentence: "他______於人，從不求回報，令人敬佩。" },
            { word: "凡事", definition: "無論什麼事情。", sentence: "他心思縝密，______都替人設想周到。" },
            { word: "預留", definition: "事先保留。", sentence: "家人知道他今天會晚回家，已先幫他______飯菜。" },
            { word: "樂極生悲", definition: "歡樂至極，往往會轉生悲愁。", sentence: "他高興的跳起來，結果扭傷腳踝，真是______。" },
            { word: "深入淺出", definition: "以淺顯易懂的文辭，表達深刻的道理。", sentence: "老師的講解______，讓同學很快就明白了。" },
            { word: "未雨綢繆", definition: "比喻事先預備，防患未然。", sentence: "做事______，才能有備無患。" },
            { word: "臨渴掘井", definition: "比喻事到臨頭才想辦法解決，為時已晚。", sentence: "平時不準備，______是來不及的。" },
            { word: "山珍海味", definition: "泛指珍異豐盛的菜肴。", sentence: "過年時，媽媽準備了滿桌的______。" },
            { word: "稱心如意", definition: "符合心意，達到願望。", sentence: "祝福您新的一年萬事______。" },
            { word: "得意忘形", definition: "形容人高興過度，舉止失常。", sentence: "他只是得了一點小獎，就______，實在不應該。" },
        ]
    },
    {
        title: "第三課 談遇見更好的自己",
        vocabulary: [
            { word: "揭示", definition: "揭露、公布。", sentence: "這起事件深刻______了性別平等的重要。" },
            { word: "卓越", definition: "非常優秀，超乎常人。", sentence: "他的領導才能______，頗受主管重視。" },
            { word: "培養", definition: "長期策畫和訓練。", sentence: "作文能力的______，可從多看、多讀、多寫三方面著手。" },
            { word: "總裁", definition: "銀行或財團亦設總裁。", sentence: "總公司宣布，明年度將任命他為新一任______。" },
            { word: "瑣事", definition: "細小零碎的事情。", sentence: "他原本月底要出國旅遊，因為______纏身，所以暫緩計畫。" },
            { word: "方仲永", definition: "指天資聰穎但後天未努力而致平庸的人。", sentence: "______的故事告訴我們，天資再高也需要後天學習。" },
            { word: "耕田", definition: "泛指耕種田地的一切活動。", sentence: "農夫不辭辛苦的在農地裡______。" },
            { word: "賺錢", definition: "賺取財利。", sentence: "我們一旦步入社會，就會知道______的辛苦。" },
            { word: "聰穎", definition: "非常聰明。", sentence: "弟弟既______又用功，成績相當出色。" },
            { word: "惋惜", definition: "嘆惜、令人感覺可惜。", sentence: "這麼聰明的人竟誤入歧途，不免令人______。" },
            { word: "欠缺", definition: "短少、不夠。", sentence: "這家公司因______資金導致周轉不靈，已宣告破產。" },
            { word: "驕傲自滿", definition: "自以為了不起而傲慢自大。", sentence: "我們不能因為有一點點成就而______。" },
            { word: "昨天", definition: "前一日。", sentence: "他因為______連夜趕報告，現在累得呼呼大睡。" },
            { word: "耕耘", definition: "比喻付出精神和勞力。", sentence: "一分______，一分收穫。" },
            { word: "茁壯", definition: "成長壯大。", sentence: "嫩苗要經過細心呵護，才能成長______。" },
            { word: "日積月累", definition: "長時間不斷的累積。", sentence: "想要成功，需要______的努力。" },
            { word: "精益求精", definition: "不斷努力求進步。", sentence: "他對自己的作品要求很高，總是______。" },
        ]
    },
    {
        title: "第四課 臺灣美食詩選",
        vocabulary: [
            { word: "鼎邊趖", definition: "一種小吃。", sentence: "______是基隆著名的小吃。" },
            { word: "颳風", definition: "起風、吹風。", sentence: "若遇到______下雨，最好取消登山活動。" },
            { word: "廚師", definition: "掌理廚房烹飪事務的師傅。", sentence: "這家餐廳增聘了好幾位______。" },
            { word: "晒乾", definition: "將潮溼物品置於日光下曝晒。", sentence: "我們會把衣服拿到頂樓陽臺去______。" },
            { word: "包覆", definition: "包裹覆蓋。", sentence: "這家店的雞排______著起司內餡，極為美味。" },
            { word: "竹筍", definition: "竹子地下莖所生的嫩芽。", sentence: "______是夏天常見的食材。" },
            { word: "醃製", definition: "以醃漬方法所製成。", sentence: "這家餐廳______的醬瓜非常好吃。" },
            { word: "攪拌", definition: "攪動、拌合。", sentence: "他用筷子把肉餡______均勻，就開始包水餃了。" },
            { word: "油炸", definition: "利用煮沸的油使食物熟透。", sentence: "年糕裹上麵粉後______，就成為美味的點心。" },
            { word: "晶瑩", definition: "明亮透澈。", sentence: "樹梢、葉間沾滿了一顆顆______的水珠。" },
            { word: "饗宴", definition: "招待賓客的宴席。", sentence: "能受邀參加這場群星雲集的______，讓我感到光榮。" },
            { word: "彰化", definition: "縣名。", sentence: "______縣與雲林縣以濁水溪為界。" },
            { word: "豬肉", definition: "從豬身上取得的肉。", sentence: "他買回絞碎的______，準備作為包水餃的材料。" },
            { word: "華燈初上", definition: "天色剛暗，家家戶戶開始點燈。", sentence: "每到______，夜市就開始熱鬧起來。" },
            { word: "人來人往", definition: "指來往的人很多。", sentence: "這個觀光景點總是______，非常熱鬧。" },
            { word: "擁擠", definition: "人、物眾多密集的樣子。", sentence: "假日百貨公司裡到處都是______的人潮。" },
            { word: "著名", definition: "名聲響亮。", sentence: "阿里山是臺灣______的風景區。" },
            { word: "街頭巷尾", definition: "泛指街巷的每個地方。", sentence: "這件事早已傳遍______，無人不知。" },
            { word: "流連", definition: "貪戀沉迷，不忍離去。", sentence: "這裡的風景太美，讓遊客們______忘返。" },
        ]
    },
    {
        title: "第五課 最好的味覺禮物",
        vocabulary: [
            { word: "泡沫", definition: "聚在一堆的許多小氣泡。", sentence: "肥皂水經攪拌後會產生許多______。" },
            { word: "下午茶", definition: "午後的社交活動或休息時間。", sentence: "公司決定推動______，以提振工作士氣。" },
            { word: "退避三舍", definition: "指為避免正面衝突而主動讓步。", sentence: "他說話很不得體，我一看見他就會______。" },
            { word: "熬煮", definition: "用小火慢慢烹煮。", sentence: "這高湯是用排骨______而成的，味道特別鮮美。" },
            { word: "砂糖", definition: "由蔗糖製成的顆粒狀糖。", sentence: "咖啡裡的______，用湯匙輕輕攪拌就融化了。" },
            { word: "混合", definition: "摻雜調和。", sentence: "他把多種水果和水______，打成綜合果汁。" },
            { word: "焦糖", definition: "蔗糖加熱所製成的棕色物質。", sentence: "他在爆米花上淋上______糖漿，看起來真美味。" },
            { word: "判斷", definition: "判別斷定。", sentence: "事情還未全面了解前，難以______是非曲直。" },
            { word: "熱騰騰", definition: "形容很熱或冒著熱氣的樣子。", sentence: "冬天裡，喝一碗______的湯，真是一大享受。" },
            { word: "啜飲", definition: "喝、吸食。", sentence: "在寧靜的夜裡，______一口咖啡，可以忘卻煩憂。" },
            { word: "流淌", definition: "流動。在本課是指流下、流出。", sentence: "每一次淚水______的經驗，都會是我們成長的養分。" },
            { word: "豐沛", definition: "充足、充沛。", sentence: "今年梅雨季帶來______的雨量，解除了缺水危機。" },
            { word: "粉身碎骨", definition: "比喻犧牲生命。", sentence: "為了國家，他早已抱定______的決心。" },
            { word: "縱使", definition: "即使。", sentence: "______困難重重，我們也要堅持下去。" },
            { word: "遊說", definition: "以言語說動他人，使聽從自己的主張。", sentence: "經過一番______，他終於同意了我們的計畫。" },
            { word: "四面八方", definition: "周圍各方。", sentence: "觀眾從______湧入會場。" },
            { word: "麻痺", definition: "比喻對事情失去應有的反應。", sentence: "看多了悲慘的報導，他似乎有些______了。" },
        ]
    },
    {
        title: "第六課 珍珠奶茶",
        vocabulary: [
            { word: "歐洲", definition: "世界五大洲之一。", sentence: "這家航空公司每週有三班飛機飛往______。" },
            { word: "標榜", definition: "揭示、標舉。", sentence: "現在的洗衣機大多______全自動，操作方便。" },
            { word: "烹茶", definition: "沏茶、泡茶。", sentence: "我喜歡在清晨______，享受那寧靜的時刻。" },
            { word: "樹薯", definition: "植物名。其塊根可供食用或製粉。", sentence: "______是酒精及味精的主要原料。" },
            { word: "粉末", definition: "細末狀的固體顆粒。", sentence: "幼兒吃的藥，多半會先把藥粒碾成______。" },
            { word: "黏稠", definition: "濃稠有黏性的。", sentence: "柏油燒熔之後會變成______的液體。" },
            { word: "添加物", definition: "為了某種用途而增加進去的東西。", sentence: "零食中常含有色素、香料等______，對人體沒有好處。" },
            { word: "呈現", definition: "出現、顯現。", sentence: "這幅畫用色鮮豔，______活潑的風格。" },
            { word: "習慣", definition: "長期養成，不易改變的行為模式。", sentence: "飯前洗手，飯後漱口，是一種良好的______。" },
            { word: "舞蹈", definition: "一種藝術形式。", sentence: "為了準備下星期的______比賽，班長加強練習。" },
            { word: "徜徉", definition: "安閒自在的四處走動。", sentence: "他喜歡一個人無憂無慮的______在青山綠水間。" },
            { word: "講究", definition: "注重、重視。", sentence: "他對穿著非常______，總是一絲不苟。" },
            { word: "老老實實", definition: "心地坦誠，舉止規矩。", sentence: "做人要______，不要投機取巧。" },
            { word: "激賞", definition: "極為讚賞。", sentence: "他的畫作出神入化，令人______不已。" },
        ]
    },
    {
        title: "第七課 大小剛好的鞋子",
        vocabulary: [
            { word: "仰光", definition: "緬甸最大和最重要的工商業城市。", sentence: "叔叔計畫下週要到______出差。" },
            { word: "緬甸", definition: "國名。位於亞洲東南部。", sentence: "______的曼德勒是紅寶石的著名產地。" },
            { word: "腳踝", definition: "小腿與腳掌間，腳骨兩旁凸起的部位。", sentence: "他因車禍跌傷了______，現在只能拄著枴杖走路。" },
            { word: "呢絨", definition: "用獸毛或人造毛等製成的毛織品的統稱。", sentence: "綿羊的毛可以用來製作______，十分保暖。" },
            { word: "下襬", definition: "上衣、長袍和裙子等的下緣部分。", sentence: "騎車時要小心，千萬別讓______捲到車輪裡。" },
            { word: "恣意", definition: "放任而不加以约束。", sentence: "他憑藉職位上的威權______妄為，引起許多人的不滿。" },
            { word: "批判", definition: "評論判斷。", sentence: "他一向關心時事，經常______社會的不合理現象。" },
            { word: "行徑", definition: "行為、舉動。", sentence: "他那鬼鬼祟祟的______，怎能叫人不起疑心？" },
            { word: "謹記", definition: "恭謹牢記。", sentence: "只能______教訓，不再犯同樣的錯誤。" },
            { word: "恰恰", definition: "恰巧、剛好。", sentence: "這個袋子______可以裝進二十公斤的麵粉。" },
            { word: "乏人問津", definition: "沒有人洽詢或探問。", sentence: "這棟預售屋推出多時，但一直______。" },
            { word: "放之四海而皆準", definition: "用到任何地方都可作為準則。", sentence: "實踐是檢驗真理的唯一方法，這是______的道理。" },
            { word: "嗤之以鼻", definition: "表示不屑或鄙視。", sentence: "他對報紙上的傳聞，一概______。" },
            { word: "著地", definition: "落地。", sentence: "他從高處跳下，平穩的______。" },
            { word: "理所當然", definition: "依道理推想應當是如此。", sentence: "孝順父母是______的事。" },
            { word: "受用不盡", definition: "蒙受其利。", sentence: "良好的閱讀習慣，可以讓人______。" },
            { word: "不屑", definition: "輕視而不加以注意。", sentence: "他對作弊的行為感到非常______。" },
            { word: "捏一把冷汗", definition: "形容非常擔心的樣子。", sentence: "看到機車飛快地衝過去，真讓人______。" },
        ]
    },
    {
        title: "第八課 狐假虎威",
        vocabulary: [
            { word: "縫隙", definition: "空隙。", sentence: "冷風從窗戶的______吹了進來。" },
            { word: "旨意", definition: "主旨目的。", sentence: "只要你多讀幾次，就能明白作者的______。" },
            { word: "悠閒", definition: "閒適自得而無所牽掛。", sentence: "他______的在園區步道裡散步。" },
            { word: "寓言", definition: "以淺近假託的故事表達哲理。", sentence: "好聽的______故事，能教會我們許多道理。" },
            { word: "鷸蚌相爭", definition: "比喻兩相爭執必會造成兩敗俱傷。", sentence: "你們再爭執不休就會如同______一樣，讓第三者得利。" },
            { word: "狡兔三窟", definition: "比喻人有多處藏身的地方或多種避禍的準備。", sentence: "他可是______，想找到他很不容易。" },
            { word: "狡猾", definition: "詭變多詐。", sentence: "他像狐狸般______，你千萬不要上當！" },
            { word: "招搖撞騙", definition: "假借他人的名義或聲勢而到處詐騙。", sentence: "他假借董事長的名義到處______。" },
            { word: "偽裝", definition: "假裝，改裝掩飾真正的面目或身分。", sentence: "警方派出便衣人員______成賭客，破獲此一大賭場。" },
            { word: "誇大", definition: "言語超過原有的事實。", sentence: "媒體對事件過度______報導，常會誤導民眾。" },
            { word: "分辨", definition: "辨別。", sentence: "這對雙胞胎長得太像了，很難______誰是姐姐。" },
            { word: "謊言", definition: "不實在的話。", sentence: "______遲早會被拆穿，你何不現在就實話實說？" },
            { word: "諷刺", definition: "以隱微的方式嘲諷譏刺。", sentence: "這位畫家畫了一篇連環漫畫來______執政者。" },
            { word: "警惕", definition: "心生警覺而加以戒備。", sentence: "接到可疑的電話都要保持______，以免落入陷阱。" },
            { word: "觀察", definition: "仔細察看。", sentence: "他好奇的______螞蟻的活動。" },
            { word: "蒙蔽", definition: "欺騙、隱瞞事實的真相。", sentence: "幸好你把事情真相說清楚，不然大家都被他所______。" },
            { word: "虛張聲勢", definition: "誇大聲威氣勢，用以嚇阻或欺騙他人。", sentence: "他個性膽小，卻往往______，耀武揚威。" },
            { word: "狐假虎威", definition: "比喻藉著有權者的威勢欺壓他人。", sentence: "他仗著父親的權勢______，大家都非常討厭他。" },
            { word: "急中生智", definition: "在緊急狀況下突然想出應付的方法。", sentence: "就在這危急關頭，他______，想出了一個好辦法。" },
            { word: "半信半疑", definition: "有點兒相信，也有點兒懷疑。", sentence: "對於這個消息，他感到______。" },
            { word: "落荒而逃", definition: "倉皇逃走。", sentence: "看到警察出現，小偷立刻______。" },
            { word: "盲目", definition: "比喻認識不清，心無定見。", sentence: "我們不應該______崇拜偶像。" },
            { word: "信以為真", definition: "相信是真的。", sentence: "他把網路上的謠言______，結果鬧了笑話。" },
            { word: "作威作福", definition: "藉著權勢來欺壓別人。", sentence: "他當上主管後，便開始______，欺壓下屬。" },
        ]
    },
    {
        title: "第九課 空城計",
        vocabulary: [
            { word: "街亭", definition: "三國時期重要陣地。", sentence: "重地______失守後，讓諸葛亮陣營元氣大傷。" },
            { word: "誘敵", definition: "引誘敵人。", sentence: "為了解救同伴，他不惜現身______。" },
            { word: "司馬懿", definition: "三國時魏將。", sentence: "______少年時期就胸懷謀略，想為國家盡一分心力。" },
            { word: "旗幟", definition: "泛稱旌旗。", sentence: "園遊會場上飄著許多畫有動物圖案的______。" },
            { word: "崗位", definition: "職責、本分。", sentence: "人人應堅守______，努力不懈，社會才會進步。" },
            { word: "百姓", definition: "泛指一般平民、國民。", sentence: "政府實行革新政策，使得______生活康樂。" },
            { word: "倘若", definition: "如果、假使。", sentence: "______這件事不是你做的，為什麼見了我就跑？" },
            { word: "書僮", definition: "舊時侍候主人讀書的未成年僮僕。", sentence: "有了平板隨時可以上網查詢，好像多了一個小______。" },
            { word: "撤退", definition: "放棄陣地或遷離已占領的地區。", sentence: "指揮官見情勢失利，便馬上下令______。" },
            { word: "諸葛亮", definition: "三國 蜀漢人，足智多謀。", sentence: "______是三國故事中的傳奇人物，受到後人的景仰。" },
            { word: "謹慎", definition: "仔細慎重。", sentence: "公司決定派個______的老手，負責品管的查驗工作。" },
            { word: "丞相", definition: "古時輔佐天子處理國事的最高行政官員。", sentence: "唐太宗任用房玄齡、杜如晦來擔任______。" },
            { word: "調度", definition: "安排配置。", sentence: "這次活動的人員______，由他全權負責。" },
            { word: "埋伏", definition: "暗中躲藏，伺機突擊敵人。", sentence: "軍隊在山谷中設下______，等待敵人上鉤。" },
            { word: "不時之需", definition: "臨時或預料之外的需用。", sentence: "平時多存點錢，以備______。" },
            { word: "蜂擁而來", definition: "形容許多人一起過來。", sentence: "偶像一出現，粉絲們便______。" },
            { word: "驚慌失措", definition: "驚嚇慌張得不知如何應付。", sentence: "聽到火警警報，大家都______地往外跑。" },
            { word: "端坐", definition: "端正身體而坐。", sentence: "他______在椅子上，靜靜地看書。" },
            { word: "氣定神閒", definition: "形容人的神態安詳閒適。", sentence: "即使面對大場面，他依然______，毫不緊張。" },
            { word: "一探究竟", definition: "看清楚、弄明白。", sentence: "對於這個神祕的傳說，他決定親自去______。" },
            { word: "旁若無人", definition: "形容言行舉止毫無顧忌。", sentence: "他在公共場合大聲喧嘩，一副______的樣子。" },
            { word: "驚魂", definition: "受驚嚇的心緒。", sentence: "那場意外讓他______未定，久久無法平復。" },
            { word: "迫不得已", definition: "出於無奈，不得不如此。", sentence: "他是______才說謊的，請你原諒他吧。" },
            { word: "折服", definition: "佩服、信服。", sentence: "他精湛的琴藝，讓在場所有人都為之______。" },
            { word: "神機妙算", definition: "神奇的機謀策略。", sentence: "多虧了你的______，我們才能順利完成任務。" },
            { word: "神鬼莫測", definition: "形容極隱密奇異，無法預料。", sentence: "他的戰術運用______，讓敵人難以捉摸。" },
        ]
    },
    {
        title: "第十課 耶誕節",
        vocabulary: [
            { word: "耶誕節", definition: "紀念耶穌誕生的節日。", sentence: "______不僅是西方的重要節日，在臺灣也形成熱鬧的節慶氣氛。" },
            { word: "郊外", definition: "環繞城市外面的地方。", sentence: "每逢晴朗的假日，我們一家人會前往______踏青。" },
            { word: "慈祥", definition: "慈善祥和。", sentence: "祖母見到兒孫們，臉上總會露出______的笑容。" },
            { word: "劈啪", definition: "狀聲詞。形容燃燒時爆裂的聲音。", sentence: "木柴在壁爐裡______的燃燒著。" },
            { word: "零用錢", definition: "零碎花用的錢。", sentence: "他習慣將每個月剩下的______存在銀行。" },
            { word: "厭倦", definition: "不再喜歡或提不起興趣。", sentence: "他對學習從不感到______，總是充滿好奇心。" },
            { word: "辯護", definition: "提出理由、事實來加以袒護。", sentence: "為了怕他被罵，我費心的替他______。" },
            { word: "自私自利", definition: "只圖自己的私利，而不顧及一切。", sentence: "______的人交不到真心的朋友。" },
            { word: "貧窮", definition: "缺少錢財，生活拮据困乏。", sentence: "______驅使他奮發向上、努力念書。" },
            { word: "關係", definition: "人事物間的關連情形。", sentence: "良好的親子______，對孩子成長有正面的影響。" },
            { word: "稍微", definition: "程度或分量上極少的。", sentence: "只要______再下一點工夫，這件作品就會更完美。" },
            { word: "暖烘烘", definition: "溫暖的樣子。", sentence: "大家鑽進______的被子裡，不久就睡著了。" },
            { word: "衷心", definition: "出自內心。", sentence: "這位主管賞罰合情合理，屬下個個______信服。" },
            { word: "鋼琴", definition: "樂器名。屬鍵盤樂器。", sentence: "他從小就夢想有一架______，如今願望終於實現了。" },
            { word: "薄暮", definition: "傍晚，太陽將落的時候。", sentence: "______時分，天空的彩霞非常美麗。" },
            { word: "點醒", definition: "指點，使人醒悟。", sentence: "幸虧有你______，我才沒有繼續錯下去。" },
            { word: "罕見", definition: "少見，難得遇見。", sentence: "這種寶石在市面上非常______，價值連城。" },
        ]
    },
    {
        title: "第十一課 下午茶風波",
        vocabulary: [
            { word: "恢復", definition: "回復到原來的樣子。", sentence: "經過多年重建，這個城市又______了震災前的風貌。" },
            { word: "活潑", definition: "生動而不呆板。", sentence: "他的個性______，交遊廣闊。" },
            { word: "草莓", definition: "植物名。果實味酸甜，可生食或製果醬。", sentence: "苗栗的大湖以產______遠近馳名。" },
            { word: "客廳", definition: "用來接待賓客的場所。", sentence: "晚飯後，我們全家常聚在______聊天。" },
            { word: "前額", definition: "額頭。", sentence: "園丁在烈日下修剪花木，______早已布滿了汗珠。" },
            { word: "灌醉", definition: "勉強別人喝酒以致於酒醉。", sentence: "與朋友聚餐時，不要勉強飲酒，以免意外被______。" },
            { word: "原諒", definition: "寬恕諒解。", sentence: "只要你願意痛改前非，大家會______你的。" },
            { word: "雙脣", definition: "上、下嘴脣。", sentence: "天氣寒冷，他凍得______發紫。" },
            { word: "乞求", definition: "懇求、請求。", sentence: "他為遲到一事，再三的______朋友諒解。" },
            { word: "神采煥發", definition: "精神充足，光采照人。", sentence: "他依舊______，樂觀積極的看待人生。" },
            { word: "雪橇", definition: "在雪地上滑行的無輪交通工具。", sentence: "傳說中的耶誕老人會駕著______分贈禮物。" },
            { word: "迴盪", definition: "迴旋飄浮。", sentence: "他優美的歌聲，______在山林間。" },
            { word: "有模有樣", definition: "形容人架勢十足的樣子。", sentence: "他學起大人的動作，真是______。" },
            { word: "手足無措", definition: "形容遇事慌亂，不知如何是好。", sentence: "突如其來的意外，讓他______。" },
            { word: "暴跳如雷", definition: "形容人急怒的樣子。", sentence: "聽到這個壞消息，他氣得______。" },
            { word: "淚流滿面", definition: "淚水布滿整個臉龐。", sentence: "看到感人的電影情節，她不禁______。" },
            { word: "愣住", definition: "發呆、失神。", sentence: "他被眼前的美景嚇得______了。" },
            { word: "無心之過", definition: "非故意所造成的過錯。", sentence: "這次的失誤是我的______，請你原諒我。" },
            { word: "央求", definition: "懇求、請求。", sentence: "他苦苦______媽媽，希望能多看一會兒電視。" },
            { word: "諒解", definition: "了解實情而原諒。", sentence: "希望你能______我的苦衷。" },
            { word: "垂頭喪氣", definition: "形容意志消沉的樣子。", sentence: "考試考差了，他______地走回家。" },
            { word: "無精打采", definition: "沒精神，提不起勁的樣子。", sentence: "昨天沒睡好，他今天看起來______的。" },
            { word: "不眠不休", definition: "不睡覺不休息，不停的做某事。", sentence: "為了趕工，他______地工作了兩天。" },
            { word: "和好如初", definition: "回復到以往和善融洽的關係。", sentence: "吵架之後，他們很快就______了。" },
        ]
    },
    {
        title: "第十二課 祕密花園",
        vocabulary: [
            { word: "訝異", definition: "覺得意外，難以相信。", sentence: "他的身體恢復得如此迅速，真令人______！" },
            { word: "臉頰", definition: "臉的兩邊。", sentence: "小嬰兒的______白皙粉嫩，相當可愛。" },
            { word: "蓬勃", definition: "茂盛繁榮的樣子。", sentence: "花園裡呈現出______的生命力。" },
            { word: "家庭醫師", definition: "照顧家庭各成員健康的第一線醫師。", sentence: "我們的______是一位非常細心的醫師。" },
            { word: "嚴肅", definition: "態度嚴正莊重。", sentence: "他神色______的訓誡犯錯的學生。" },
            { word: "薔薇", definition: "植物名。枝幹多刺，花朵富有香氣。", sentence: "庭園裡種滿了______，非常好看。" },
            { word: "瀰漫", definition: "遍布、滿布。", sentence: "水面上大霧______，完全看不見對面的景物。" },
            { word: "包括", definition: "包含、涵蓋。", sentence: "這家餐廳的菜單______了中、日、西式料理。" },
            { word: "螞蟻", definition: "蟻科昆蟲的總稱。", sentence: "他興味盎然的看著______，把自己想像成其中一員。" },
            { word: "儘管", definition: "即使、雖然。", sentence: "______他不會出席，我們還是會幫他保留位置。" },
            { word: "洋溢", definition: "充滿而流露出來。", sentence: "他的臉上______著幸福的笑容。" },
            { word: "妥當", definition: "適當、穩當。", sentence: "這件事交給他辦，絕對______。" },
            { word: "彬彬有禮", definition: "形容人的禮貌恰到好處。", sentence: "他對人總是______，很受大家歡迎。" },
            { word: "古怪", definition: "奇怪、怪異。", sentence: "他的脾氣有點______，讓人難以捉摸。" },
            { word: "怪裡怪氣", definition: "奇特古怪，異於平常。", sentence: "他今天的行為______的，不知道發生了什麼事。" },
            { word: "濃郁", definition: "香氣濃烈。", sentence: "咖啡的______香氣，飄散在整個屋子裡。" },
            { word: "多采多姿", definition: "內容豐富華麗，且變化多端。", sentence: "大學生活______，充滿了各種挑戰與機會。" },
            { word: "敬意", definition: "尊敬的心意。", sentence: "他對老師充滿了______。" },
        ]
    },
];

// --- CURRENT STATE ---
let currentLessonData = {};
let currentVocabulary = [];

// --- UTILS & SCREEN MANAGEMENT ---
const allScreens = document.querySelectorAll('.screen');
const gameHeader = document.getElementById('game-header');
const gameTitle = document.getElementById('game-title');
const gamemodeTitle = document.getElementById('gamemode-title');

function shuffleArray(array) {
    for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
    }
    return array;
}

function showScreen(screenId) {
    allScreens.forEach(s => s.style.display = 'none');
    gameHeader.style.display = 'none';

    if (screenId.startsWith('screen-')) {
         document.getElementById(screenId).style.display = 'block';
    } else {
        document.getElementById(`screen-${screenId}`).style.display = 'block';
    }

    if (['flashcard', 'matching', 'memory', 'quiz'].includes(screenId)) {
        gameHeader.style.display = 'flex';
    }
}

function selectLesson(lessonIndex) {
    currentLessonData = allLessonsData[lessonIndex];
    currentVocabulary = currentLessonData.vocabulary;
    gamemodeTitle.textContent = currentLessonData.title;
    showScreen('gamemode-select');
}

function startMode(mode) {
    const titles = {
        'flashcard-word': '閃卡練習 (看詞語)',
        'flashcard-def': '反向閃卡 (看解釋)',
        'matching': '配對遊戲',
        'memory': '記憶遊戲',
        'quiz': '綜合測驗'
    };
    gameTitle.textContent = titles[mode];
    
    if (mode.startsWith('flashcard')) {
        initFlashcards(mode === 'flashcard-word');
        showScreen('flashcard');
    } else if (mode === 'matching') {
        initMatchingGame();
        showScreen('matching');
    } else if (mode === 'memory') {
        initMemoryGame();
        showScreen('memory');
    } else if (mode === 'quiz') {
        initQuiz(currentVocabulary);
        showScreen('quiz');
    }
}


// --- INITIALIZE LESSON SELECTION ---
function initLessonSelection() {
    const lessonListContainer = document.getElementById('lesson-list');
    lessonListContainer.innerHTML = ''; // Clear previous buttons if any
    allLessonsData.forEach((lesson, index) => {
        const button = document.createElement('button');
        button.className = 'menu-btn bg-white p-4 rounded-xl shadow-md text-center';
        button.innerHTML = `<h2 class="text-lg font-bold text-slate-800">${lesson.title}</h2>`;
        button.onclick = () => selectLesson(index);
        lessonListContainer.appendChild(button);
    });
}


// --- FLASHCARD LOGIC ---
let flashcardIndex = 0;
let isWordFront = true;
const screenFlashcard = document.getElementById('screen-flashcard');

function initFlashcards(wordIsFront) {
    screenFlashcard.innerHTML = `
        <div class="flashcard-container w-full h-80 sm:h-96 mb-6 cursor-pointer" onclick="this.classList.toggle('is-flipped')">
            <div class="flashcard-inner">
                <div class="flashcard-front">
                    <p id="flashcard-front-text" class="text-4xl md:text-6xl font-bold text-center"></p>
                </div>
                <div class="flashcard-back">
                    <div id="flashcard-back-content" class="text-center">
                         <h3 id="flashcard-back-title" class="text-2xl md:text-3xl font-bold mb-4"></h3>
                         <p id="flashcard-back-def" class="text-base md:text-lg whitespace-pre-line mb-4"></p>
                         <p id="flashcard-back-sentence" class="text-base md:text-lg whitespace-pre-line text-amber-700"></p>
                    </div>
                </div>
            </div>
        </div>
         <div class="flex justify-between items-center">
            <button id="flashcard-prev" class="bg-white py-3 px-6 rounded-full shadow-md">上一個</button>
            <div id="flashcard-progress" class="text-slate-600"></div>
            <button id="flashcard-next" class="bg-sky-600 text-white font-bold py-3 px-6 rounded-full shadow-lg">下一個</button>
        </div>`;
    
    flashcardIndex = 0;
    isWordFront = wordIsFront;
    shuffleArray(currentVocabulary);
    updateFlashcard();

    document.getElementById('flashcard-next').addEventListener('click', () => {
        flashcardIndex = (flashcardIndex + 1) % currentVocabulary.length;
        updateFlashcard();
    });
    document.getElementById('flashcard-prev').addEventListener('click', () => {
        flashcardIndex = (flashcardIndex - 1 + currentVocabulary.length) % currentVocabulary.length;
        updateFlashcard();
    });
}

function updateFlashcard() {
    const card = currentVocabulary[flashcardIndex];
    const fullSentence = card.sentence.replace('______', card.word);
    
    const fcFrontText = document.getElementById('flashcard-front-text');
    const fcBackTitle = document.getElementById('flashcard-back-title');
    const fcBackDef = document.getElementById('flashcard-back-def');
    const fcBackSentence = document.getElementById('flashcard-back-sentence');
    const fcProgress = document.getElementById('flashcard-progress');
    
    if (isWordFront) {
        fcFrontText.textContent = card.word;
        fcBackTitle.textContent = card.word;
        fcBackDef.textContent = card.definition;
        fcBackSentence.textContent = `例句：${fullSentence}`;
    } else {
        fcFrontText.textContent = card.definition;
        fcBackTitle.textContent = card.word;
        fcBackDef.textContent = card.definition;
        fcBackSentence.textContent = `例句：${fullSentence}`;
    }
    fcProgress.textContent = `${flashcardIndex + 1} / ${currentVocabulary.length}`;
    document.querySelector('.flashcard-container').classList.remove('is-flipped');
}


// --- MATCHING GAME LOGIC ---
let selectedWord = null, selectedDef = null;
let matchedCount = 0;
const screenMatching = document.getElementById('screen-matching');

function initMatchingGame() {
    screenMatching.innerHTML = `
        <p id="matching-status" class="text-center text-slate-600 mb-4 h-6"></p>
         <div class="grid grid-cols-2 gap-4">
             <div id="matching-col-1" class="space-y-3"></div>
             <div id="matching-col-2" class="space-y-3"></div>
         </div>`;

    const matchingCol1 = document.getElementById('matching-col-1');
    const matchingCol2 = document.getElementById('matching-col-2');
    
    selectedWord = null;
    selectedDef = null;
    matchedCount = 0;
    document.getElementById('matching-status').textContent = `已配對: 0 / ${currentVocabulary.length}`;

    const words = shuffleArray([...currentVocabulary]);
    const defs = shuffleArray([...currentVocabulary]);

    words.forEach(item => {
        const div = document.createElement('div');
        div.textContent = item.word;
        div.dataset.word = item.word;
        div.className = 'match-item p-4 rounded-lg text-center';
        div.onclick = () => selectMatchItem(div, 'word');
        matchingCol1.appendChild(div);
    });

    defs.forEach(item => {
        const div = document.createElement('div');
        div.textContent = item.definition;
        div.dataset.word = item.word;
        div.className = 'match-item p-4 rounded-lg text-center';
        div.onclick = () => selectMatchItem(div, 'def');
        matchingCol2.appendChild(div);
    });
}

function selectMatchItem(element, type) {
    if (element.classList.contains('matched')) return;

    if (type === 'word') {
        if (selectedWord) selectedWord.classList.remove('selected');
        selectedWord = element;
        selectedWord.classList.add('selected');
    } else {
        if (selectedDef) selectedDef.classList.remove('selected');
        selectedDef = element;
        selectedDef.classList.add('selected');
    }

    if (selectedWord && selectedDef) {
        if (selectedWord.dataset.word === selectedDef.dataset.word) {
            selectedWord.classList.add('matched');
            selectedDef.classList.add('matched');
            selectedWord.classList.remove('selected');
            selectedDef.classList.remove('selected');
            selectedWord = null;
            selectedDef = null;
            matchedCount++;
            document.getElementById('matching-status').textContent = `已配對: ${matchedCount} / ${currentVocabulary.length}`;
            if (matchedCount === currentVocabulary.length) {
                document.getElementById('matching-status').textContent = '恭喜！全部配對成功！';
            }
        } else {
            selectedWord.classList.add('incorrect');
            selectedDef.classList.add('incorrect');
            setTimeout(() => {
                if (selectedWord) selectedWord.classList.remove('incorrect', 'selected');
                if (selectedDef) selectedDef.classList.remove('incorrect', 'selected');
                selectedWord = null;
                selectedDef = null;
            }, 500);
        }
    }
}


// --- MEMORY GAME LOGIC ---
let flippedCards = [];
let moves = 0;
let memoryMatchedCount = 0;
let memoryGameVocab = [];
const screenMemory = document.getElementById('screen-memory');

function initMemoryGame() {
    screenMemory.innerHTML = `
        <div class="flex justify-between items-center mb-4">
            <p class="text-slate-600">已找到配對: <span id="memory-found">0</span> / <span id="memory-total"></span></p>
            <p class="text-slate-600">步數: <span id="memory-moves">0</span></p>
        </div>
        <div id="memory-grid" class="grid grid-cols-4 gap-2 sm:gap-3"></div>`;
    
    const memoryGrid = document.getElementById('memory-grid');
    moves = 0;
    memoryMatchedCount = 0;
    flippedCards = [];

    memoryGameVocab = shuffleArray([...currentVocabulary]).slice(0, 8);
    
    document.getElementById('memory-moves').textContent = 0;
    document.getElementById('memory-found').textContent = 0;
    document.getElementById('memory-total').textContent = memoryGameVocab.length;

    let cardsData = [];
    memoryGameVocab.forEach(item => {
        cardsData.push({ type: 'word', content: item.word, matchId: item.word });
        cardsData.push({ type: 'def', content: item.definition, matchId: item.word });
    });
    shuffleArray(cardsData);

    cardsData.forEach(data => {
        const card = document.createElement('div');
        card.className = 'memory-card h-24';
        card.dataset.matchId = data.matchId;
        card.innerHTML = `
            <div class="memory-card-inner">
                <div class="memory-card-front">?</div>
                <div class="memory-card-back">${data.content}</div>
            </div>`;
        card.addEventListener('click', () => flipMemoryCard(card));
        memoryGrid.appendChild(card);
    });
}

function flipMemoryCard(card) {
    if (flippedCards.length < 2 && !card.classList.contains('is-flipped') && !card.classList.contains('matched')) {
        card.classList.add('is-flipped');
        flippedCards.push(card);

        if (flippedCards.length === 2) {
            moves++;
            document.getElementById('memory-moves').textContent = moves;
            checkMemoryMatch();
        }
    }
}

function checkMemoryMatch() {
    const [card1, card2] = flippedCards;
    if (card1.dataset.matchId === card2.dataset.matchId) {
        setTimeout(() => {
            card1.classList.add('matched');
            card2.classList.add('matched');
            memoryMatchedCount++;
            document.getElementById('memory-found').textContent = memoryMatchedCount;
            if(memoryMatchedCount === memoryGameVocab.length) {
                // Game over
            }
        }, 500);
    } else {
        setTimeout(() => {
            card1.classList.remove('is-flipped');
            card2.classList.remove('is-flipped');
        }, 1000);
    }
    setTimeout(() => { flippedCards = []; }, 1000);
}


// --- QUIZ LOGIC ---
const quizScreen = document.getElementById('screen-quiz');
let quizQuestions = [];
let currentQuizIndex = 0;
let score = 0;
let incorrectAnswers = [];

function initQuiz(questionsData) {
    currentQuizIndex = 0;
    score = 0;
    incorrectAnswers = [];
    
    let tempQuestionsData = [...questionsData];

    quizQuestions = tempQuestionsData.map(item => {
        const otherWords = currentVocabulary.filter(v => v.word !== item.word).map(v => v.word);
        shuffleArray(otherWords);
        const distractors = otherWords.slice(0, 3);
        const options = [item.word, ...distractors];
        shuffleArray(options);
        return {
            original: item,
            text: item.sentence,
            options: options,
            correctAnswer: item.word
        };
    });
    shuffleArray(quizQuestions);
    
    displayQuizQuestion();
}

function displayQuizQuestion() {
    if (currentQuizIndex >= quizQuestions.length) {
        displayQuizResults();
        return;
    }
    
    const question = quizQuestions[currentQuizIndex];
    const progress = (currentQuizIndex / quizQuestions.length) * 100;

    quizScreen.innerHTML = `
        <header class="mb-6">
            <div class="flex justify-between items-center mb-2">
                <h1 class="text-xl sm:text-2xl font-bold text-sky-800">生詞理解測驗</h1>
                <div class="text-sm font-medium text-slate-500">問題 ${currentQuizIndex + 1} / ${quizQuestions.length}</div>
            </div>
            <div class="w-full bg-slate-200 rounded-full h-2.5">
                <div class="bg-sky-600 h-2.5 rounded-full transition-all duration-300" style="width: ${progress}%"></div>
            </div>
        </header>
        <main>
            <div class="bg-slate-100 p-4 sm:p-6 rounded-lg mb-6">
               <p class="text-lg sm:text-xl text-center font-medium h-24 flex items-center justify-center">${question.text}</p>
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                ${question.options.map(opt => `<button class="quiz-option-btn w-full p-4 border-2 border-slate-300 rounded-lg text-lg bg-white hover:bg-sky-100 hover:border-sky-400" onclick="selectQuizAnswer(this, '${opt.replace(/'/g, "\\'")}', '${question.correctAnswer.replace(/'/g, "\\'")}')">${opt}</button>`).join('')}
            </div>
            <div class="mt-4 text-center h-6">
                 <p id="quiz-feedback" class="font-bold"></p>
            </div>
            <div class="mt-6 text-center">
                <button id="quiz-next-btn" class="hidden w-full sm:w-auto bg-sky-600 hover:bg-sky-700 text-white font-bold py-3 px-12 rounded-full shadow-lg" onclick="nextQuizQuestion()">
                    下一題
                </button>
            </div>
        </main>
    `;
}

function selectQuizAnswer(btn, selected, correct) {
    document.querySelectorAll('.quiz-option-btn').forEach(b => {
        b.disabled = true;
        if (b.textContent === correct) b.classList.add('!bg-green-500', '!text-white', '!border-green-600');
    });

    if (selected === correct) {
        score++;
        document.getElementById('quiz-feedback').textContent = '答對了！';
        document.getElementById('quiz-feedback').className = 'font-bold text-green-600';
    } else {
        btn.classList.add('!bg-red-500', '!text-white', '!border-red-600');
        document.getElementById('quiz-feedback').textContent = `答錯了，正確答案是：${correct}`;
        document.getElementById('quiz-feedback').className = 'font-bold text-red-600';
        if (!incorrectAnswers.some(item => item.word === quizQuestions[currentQuizIndex].original.word)) {
            incorrectAnswers.push(quizQuestions[currentQuizIndex].original);
        }
    }
    document.getElementById('quiz-next-btn').style.display = 'inline-block';
}

function nextQuizQuestion() {
    currentQuizIndex++;
    displayQuizQuestion();
}

function displayQuizResults() {
    const percentage = quizQuestions.length > 0 ? (score / quizQuestions.length) * 100 : 100;
    let message = '';
    if (percentage === 100) message = '太棒了！全部答對，你真是個詞語大師！';
    else if (percentage >= 80) message = '表現優異！繼續努力。';
    else if (percentage >= 60) message = '還不錯！對於不熟悉的詞語可以多練習幾次。';
    else message = '別灰心，多練習幾次就會更熟悉了！加油！';

    quizScreen.innerHTML = `
        <div class="text-center">
            <h1 class="text-3xl font-bold text-sky-800 mb-4">測驗完成！</h1>
            <p class="text-lg text-slate-600 mb-2">你的成績是：</p>
            <p class="text-6xl font-bold text-slate-800 mb-8">${score} / ${quizQuestions.length}</p>
            <p class="text-base text-slate-500 mb-8">${message}</p>
            <div class="space-y-4 sm:space-y-0 sm:space-x-4">
                <button onclick="initQuiz(currentVocabulary)" class="w-full sm:w-auto bg-sky-600 hover:bg-sky-700 text-white font-bold py-3 px-8 rounded-full shadow-lg">
                    完整再試一次
                </button>
                ${incorrectAnswers.length > 0 ? `<button onclick="initQuiz(incorrectAnswers)" class="w-full sm:w-auto bg-amber-500 hover:bg-amber-600 text-white font-bold py-3 px-8 rounded-full shadow-lg">只練習錯題 (${incorrectAnswers.length})</button>` : ''}
            </div>
        </div>
    `;
}

// --- START THE APP ---
window.onload = initLessonSelection;
</script>
</body>
</html>

